#!/bin/bash

# SSH User Setup Script
# Run this as root on the server
#
# Local usage: ./setup_ssh_user.sh <username> <password> "<public_key>"
# Remote usage: curl -fsSL <script_url> | bash -s -- <username> <password> "<public_key>"
#
# Example:
#   ./setup_ssh_user.sh scott MyPassword123 "ssh-ed25519 AAAAC3Nza... user@host"
#
# Note: Password will be visible in process list temporarily. Run on trusted systems only.

set -e  # Exit on any error

echo "=== SSH User Setup Script ==="
echo ""

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: This script must be run as root"
    exit 1
fi

# Check for required arguments
if [ $# -ne 3 ]; then
    echo "ERROR: Missing required arguments"
    echo "Usage: <username> <password> \"<public_key>\""
    echo ""
    echo "Local usage:"
    echo "  ./setup_ssh_user.sh scott MyPassword123 \"ssh-ed25519 AAAAC3Nza... user@host\""
    echo ""
    echo "Remote usage:"
    echo "  curl -fsSL <script_url> | bash -s -- scott MyPassword123 \"ssh-ed25519 AAAAC3Nza... user@host\""
    exit 1
fi

# Get arguments
USERNAME="$1"
USER_PASSWORD="$2"
PUBLIC_KEY="$3"

# Validate configuration
if [ -z "$USERNAME" ]; then
    echo "ERROR: Username cannot be empty"
    exit 1
fi

if [ -z "$USER_PASSWORD" ]; then
    echo "ERROR: Password cannot be empty"
    exit 1
fi

if [ -z "$PUBLIC_KEY" ]; then
    echo "ERROR: Public key cannot be empty"
    exit 1
fi

# Validate public key format (basic check)
if [[ ! "$PUBLIC_KEY" =~ ^(ssh-rsa|ssh-ed25519|ecdsa-sha2-nistp256|ecdsa-sha2-nistp384|ecdsa-sha2-nistp521) ]]; then
    echo "ERROR: Invalid public key format"
    exit 1
fi

echo "=== Starting SSH user setup for $USERNAME ==="

# Create user (skip if already exists)
if id "$USERNAME" &>/dev/null; then
    echo "User $USERNAME already exists, skipping creation..."
else
    echo "Creating user $USERNAME..."
    # Create user without prompting
    adduser --disabled-password --gecos "" "$USERNAME"
    # Set the password non-interactively
    echo "$USERNAME:$USER_PASSWORD" | chpasswd
    echo "User created with password."
fi

# Install sudo if not present
if ! command -v sudo &> /dev/null; then
    echo "Installing sudo..."
    apt update && apt install -y sudo
fi

# Add user to sudo group
echo "Adding $USERNAME to sudo group..."
usermod -aG sudo "$USERNAME"

# Create .ssh directory
echo "Setting up SSH key authentication..."
mkdir -p /home/"$USERNAME"/.ssh
chmod 700 /home/"$USERNAME"/.ssh

# Add public key to authorized_keys
echo "$PUBLIC_KEY" > /home/"$USERNAME"/.ssh/authorized_keys

# Set correct permissions
chmod 600 /home/"$USERNAME"/.ssh/authorized_keys
chown -R "$USERNAME":"$USERNAME" /home/"$USERNAME"/.ssh

echo "SSH key configured successfully!"

# Backup original sshd_config
echo "Backing up SSH config..."
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup.$(date +%Y%m%d_%H%M%S)

# Configure SSH settings
echo "Configuring SSH daemon..."

# Function to update or add a setting in sshd_config
update_ssh_setting() {
    local setting="$1"
    local value="$2"
    # Match lines that are either uncommented settings or commented with a single #
    # This avoids matching lines in comment blocks (##, ###, etc.)
    if grep -q "^#\?${setting}[[:space:]]" /etc/ssh/sshd_config; then
        # Setting exists (commented or not), replace the first occurrence
        sed -i "0,/^#\?${setting}[[:space:]].*/s/^#\?${setting}[[:space:]].*/${setting} ${value}/" /etc/ssh/sshd_config
    else
        # Setting doesn't exist, add it
        echo "${setting} ${value}" >> /etc/ssh/sshd_config
    fi
}

update_ssh_setting "PermitRootLogin" "no"
update_ssh_setting "PubkeyAuthentication" "yes"
update_ssh_setting "PasswordAuthentication" "no"
update_ssh_setting "PermitEmptyPasswords" "no"
update_ssh_setting "KbdInteractiveAuthentication" "no"
update_ssh_setting "UsePAM" "yes"
update_ssh_setting "AuthenticationMethods" "publickey"
update_ssh_setting "AllowUsers" "$USERNAME"

# Test SSH configuration
echo "Testing SSH configuration..."
if sshd -t; then
    echo "SSH configuration is valid!"
    echo "Restarting SSH service..."
    systemctl restart ssh
    echo ""
    echo "=== Setup complete! ==="
    echo "User $USERNAME can now SSH in with key authentication"
    echo "Password authentication and root login are disabled"
    echo ""
    echo "IMPORTANT: Test SSH connection in a NEW terminal before closing this one!"
    echo "If something goes wrong, your backup config is at:"
    echo "/etc/ssh/sshd_config.backup.*"
else
    echo "ERROR: SSH configuration test failed!"
    echo "Changes were not applied. Please check the configuration."
    exit 1
fi
